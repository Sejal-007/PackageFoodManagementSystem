

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "My Dashboard";
    var userName = User.Identity.IsAuthenticated ? User.Identity.Name : "User";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="container my-5">
    <div class="row">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3" style="border-radius: 15px;">
                @Html.Partial("_AccountSidebar")
            </div>
        </div>

        <div class="col-md-9">
            <div class="d-flex align-items-center mb-4">
                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                    <i class="fa-solid fa-house-user fs-4"></i>
                </div>
                <div>
                    <h2 class="fw-bold mb-0">Welcome , <span class="text-success">@userName</span> 👋</h2>

                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-12">
                    <div class="card border-0 shadow-sm p-4 text-white" style="border-radius: 20px; background: linear-gradient(135deg, #198754, #11613d);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="fw-bold mb-1"><i class="fa-solid fa-basket-shopping me-2"></i> Your Current Basket</h4>
                                <p id="cart-summary-text" class="mb-0 opacity-75">Loading your treats...</p>
                            </div>
                            <div class="text-end">
                                <a href="/User/MyBasket" class="btn btn-light rounded-pill px-4 fw-bold text-success shadow">
                                    Checkout Now <i class="fa-solid fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-4 h-100 text-center" style="border-radius: 20px; transition: 0.3s;">
                        <div class="bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width:60px; height:60px;">
                            <i class="fa-solid fa-box text-success fs-4"></i>
                        </div>
                        <h5 class="fw-bold">Orders</h5>
                        <p id="total-order-count" class="text-muted small">0 orders found</p>
                        <a href="/User/PastOrders" class="text-success fw-bold text-decoration-none small mt-auto">View History →</a>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-4 h-100 text-center" style="border-radius: 20px;">
                        <div class="bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width:60px; height:60px;">
                            <i class="fa-solid fa-wallet text-warning fs-4"></i>
                        </div>
                        <h5 class="fw-bold">Wallet</h5>
                        <p class="text-muted small">Instant Pay Active</p>
                        <a href="/User/MyWallet" class="text-warning fw-bold text-decoration-none small mt-auto">Go to Wallet →</a>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-4 h-100 text-center" style="border-radius: 20px;">
                        <div class="bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width:60px; height:60px;">
                            <i class="fa-solid fa-gift text-primary fs-4"></i>
                        </div>
                        <h5 class="fw-bold">Gift Cards</h5>
                        <p class="text-muted small">2 Active Cards</p>
                        <a href="/User/GiftCards" class="text-primary fw-bold text-decoration-none small mt-auto">Manage Cards →</a>
                    </div>
                </div>

                <div class="col-md-12 mt-2">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Recent Orders</h5>
                        <a href="/User/PastOrders" class="text-muted small text-decoration-none">View All</a>
                    </div>
                    <div id="recent-orders-list">
                        <div class="text-center py-4 bg-light rounded-4">
                            <p class="text-muted mb-0 small">No orders placed yet.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    .card:hover {
        transform: translateY(-5px);
        transition: 0.3s ease;
    }

    .bg-success-light {
        background-color: rgba(25, 135, 84, 0.1);
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. SYNC CART
        const cartData = JSON.parse(localStorage.getItem("myCart")) || [];
        const summaryText = document.getElementById("cart-summary-text");

        if (cartData.length > 0) {
            const itemCount = cartData.reduce((total, item) => total + (parseInt(item.qty) || 0), 0);
            const totalPrice = cartData.reduce((total, item) => total + (parseFloat(item.price) * (parseInt(item.qty) || 0)), 0);
            summaryText.innerHTML = `You have <strong>${itemCount} items</strong> waiting. Total: <strong>₹${totalPrice.toLocaleString()}</strong>`;
        } else {
            summaryText.innerHTML = "Your basket is currently empty. Start shopping!";
        }

        // 2. SYNC RECENT ORDERS
        const pastOrders = JSON.parse(localStorage.getItem("pastOrders")) || [];
        const recentList = document.getElementById("recent-orders-list");
        const orderCountText = document.getElementById("total-order-count");

        if (pastOrders.length > 0) {
            orderCountText.innerText = `${pastOrders.length} orders placed`;
            recentList.innerHTML = ""; // Clear empty state

            // Take the 3 most recent orders
            const latestThree = pastOrders.slice(-3).reverse();

            latestThree.forEach(order => {
                const orderRow = `
                    <div class="card border-0 shadow-sm mb-3" style="border-radius: 15px;">
                        <div class="card-body p-3 d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded-3 p-2 me-3">
                                    <i class="fa-solid fa-box text-success"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold mb-0 small">Order ${order.orderId}</h6>
                                    <p class="text-muted mb-0" style="font-size: 0.75rem;">${order.date}</p>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success-light text-success rounded-pill px-2 py-1 mb-1" style="font-size: 0.7rem;">${order.status}</span>
                                <div class="fw-bold small">₹${order.amount}</div>
                            </div>
                        </div>
                    </div>`;
                recentList.insertAdjacentHTML('beforeend', orderRow);
            });
        }
    });
</script>