@model dynamic
@{
    ViewData["Title"] = "Add Product";

    Layout = "~/Views/Shared/_StoreManagerlayout.cshtml";
}

<div class="main-content">
    <!-- Header -->
    <div class="topbar">
        <h4>| Store Name</h4>
        <input type="text" placeholder="Search" />
        <div class="icons">
            <a asp-controller="StoreManager" asp-action="Profile">

                👤

            </a>
        </div>
    </div>


    <button class="btn-add" data-bs-toggle="modal" data-bs-target="#addProductModal" onclick="clearForm()">Add Product</button>

    <table class="product-table" id="productTable">
        <thead>
            <tr>
                <th>Product Image</th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Expiry Date</th>
                <th>Status Active/Inactive</th>
                <th>Actions Edit/delete</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="img-cell"><img src="https://img.icons8.com/color/96/potato-chips.png" /></td>
                <td>Potato Chips</td>
                <td>Snacks</td>
                <td>10-100</td>
                <td>01/12/2026</td>
                <td>Active</td>
                <td><a href="javascript:void(0)" onclick="editProduct(this)" class="text-dark">Edit</a> / <a href="javascript:void(0)" onclick="deleteProduct(this)" class="text-dark">Delete</a></td>
            </tr>
        </tbody>
    </table>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Product</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="editIndex"> <div class="mb-3">
                        <label class="form-label">Product Name</label>
                        <input type="text" id="prodName" class="form-control" placeholder="Lays">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select id="prodCategory" class="form-select">
                            <option>Beverages</option>
                            <option selected>Snacks</option>
                            <option>Dairy</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Price Range</label>
                            <input type="text" id="prodPrice" class="form-control" placeholder="20">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Expiry Date</label>
                            <input type="text" id="prodExpiry" class="form-control" placeholder="01-12-2025">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Product Image URL</label>
                        <input type="text" id="prodImg" class="form-control" placeholder="https://image-link.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="prodStatus" checked>
                            <label class="form-check-label" for="prodStatus">Active</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-save" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>
</div>

@*<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>*@

<script>
    let currentRow = null;

    function clearForm() {
        document.getElementById('productForm').reset();
        document.getElementById('modalTitle').innerText = "Add New Product";
        currentRow = null;
    }

    function saveProduct() {
        const name = document.getElementById('prodName').value;
        const category = document.getElementById('prodCategory').value;
        const price = document.getElementById('prodPrice').value;
        const expiry = document.getElementById('prodExpiry').value;
        const imgUrl = document.getElementById('prodImg').value || "https://img.icons8.com/color/96/box.png";
        const status = document.getElementById('prodStatus').checked ? "Active" : "Inactive";

        if (!name || !price) { alert("Fill in Name and Price"); return; }

        const rowContent = `
            <td class="img-cell"><img src="${imgUrl}" /></td>
            <td>${name}</td>
            <td>${category}</td>
            <td>${price}</td>
            <td>${expiry}</td>
            <td>${status}</td>
            <td><a href="javascript:void(0)" onclick="editProduct(this)" class="text-dark">Edit</a> / <a href="javascript:void(0)" onclick="deleteProduct(this)" class="text-dark">Delete</a></td>
        `;

        if (currentRow) {
            currentRow.innerHTML = rowContent;
        } else {
            const tableBody = document.querySelector('#productTable tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = rowContent;
            tableBody.appendChild(newRow);
        }

        const modalElement = document.getElementById('addProductModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
        }

        setTimeout(() => {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
            document.body.style.overflow = 'auto';
        }, 100);
    }

    function deleteProduct(btn) {
        if (confirm("Are you sure you want to delete this product?")) {
            btn.closest('tr').remove();
        }
    }

    function editProduct(btn) {
        currentRow = btn.closest('tr');
        const cells = currentRow.cells;

        document.getElementById('prodName').value = cells[1].innerText;
        document.getElementById('prodCategory').value = cells[2].innerText;
        document.getElementById('prodPrice').value = cells[3].innerText;
        document.getElementById('prodExpiry').value = cells[4].innerText;
        document.getElementById('prodImg').value = cells[0].querySelector('img').src;
        document.getElementById('prodStatus').checked = (cells[5].innerText === "Active");

        document.getElementById('modalTitle').innerText = "Edit Product";

        // Use existing instance if available to avoid stacking backdrops
        const modalElement = document.getElementById('addProductModal');
        let myModal = bootstrap.Modal.getInstance(modalElement);
        if (!myModal) {
            myModal = new bootstrap.Modal(modalElement);
        }
        myModal.show();
    }
</script>